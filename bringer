#!/bin/bash

getCommand()
{
    ps -p $1 -o command= | sed 's/^[^ ]*\///g'
}

appendSortLines()
{
    local commandWindowPairs=`echo -e "$1" | sort`
    local desktop=$2
    local sortCommands=""
    for pair in $commandWindowPairs
    do
	local command="`echo $pair | cut -d ":" -f 1`"
	if [ -z $sortCommands ] 
	then
	    sortCommands="$command"
	else
	    sortCommands="${sortCommands} --- $command"
	fi
    done
    for pair in $commandWindowPairs
    do
    	sortLines="${sortLines}`echo -e "\n${sortCommands}:$pair:$desktop"`"
    done
}

getWindows()
{
    IFS=$'\n'
    local sortLines=""
    local lastDesktop
    local commandWindowPairs
    for line in `wmctrl -lp`
    do 
	local window=`echo $line | cut -d " " -f 1`
	local desktop=`echo $line | cut -d " " -f 3`
	local pid=`echo $line | cut -d " " -f 4`
    #local title=`echo $line | cut -d " " -f 1,2,3,4,5,6 --complement` 
	local command=`getCommand $pid`
	if [ "$desktop" != "${lastDesktop}" ]; then
	    if [ -n "${lastDesktop}" ]; then
#	    bringLines="$bringLines`echo -e "\n$p bring $window $command"`"
		appendSortLines "$commandWindowPairs" "$lastDesktop"
#	else
#	    bringLines="$bringLines`echo -e "$p bring $window $command"`"
 	    fi
	    commandWindowPairs="$command:$window"
	    lastDesktop=$desktop
	else
#	bringLines="$bringLines`echo -e "\n$p bring $window $command"`"
	    commandWindowPairs="${commandWindowPairs}\n$command:$window"
	fi
    done
    appendSortLines "$commandWindowPairs" "$lastDesktop"
    sortLines=`echo "$sortLines" | sort`
    # bringLines=""
    counter=1
    desktop=`wmctrl -d | grep \* | cut -d " " -f 1`
    local gotoLines=""
    for line in $sortLines 
    do 
	local command=`echo $line | cut -d ":" -f 2`
	local window=`echo $line | cut -d ":" -f 3`
	local d=`echo $line | cut -d ":" -f 4`
	local commands=`echo $line | cut -d ":" -f 1`
	if [ "$commands" != "$lastCommands" ]
	then
	    if [ -n "$gotoLines" ]
	    then
		gotoLines="$gotoLines\n"
	    fi
	    gotoLines="$gotoLines$counter goto $window "
 	    if [ "$d" = "$desktop" ]; then
		gotoLines="$gotoLines*"
	    fi
	    gotoLines="$gotoLines$commands"
	fi
	lastCommands="$commands"
	let counter=$counter+1    
    done
    echo -e "$gotoLines"
#echo "-------------------------------------------------------------------------------------------------------------------------------------------------------------------------$bringLines"
#"$bringLines" on extra line causes trouble for some reason 
#echo "-------------------------------------------------------------------------------------------------------------------------------------------------------------------------"
}

xxx()
{
    local desktop=`wmctrl -d | grep \* | cut -d " " -f 1`
    local line=`(getWindows;dmenu_path) | dmenu -i -l 13` 
    
    echo $line | grep "goto"
    
    if [ "$?" -eq "0" ]; then
	local window=`echo $line | cut -d " " -f 3`
	echo $window
	wmctrl -ia $window
    else
	echo $line | grep "bring"
	
	if [ "$?" -eq "0" ]; then
	    local window=`echo $line | cut -d " " -f 3`
	    wmctrl -iR $window
	else
	    exec $line
	fi
    fi
}

xxx