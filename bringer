#!/bin/bash

getCommand()
{
    ps -p $1 -o command= | sed 's/^[^ ]*\///g'
}

appendSortLines()
{
    local commandWindowPairs=`echo -e "$1" | sort`
    local desktop=$2
    local sortCommands=""
    local command
    for pair in $commandWindowPairs
    do
	command="`echo $pair | cut -d ":" -f 1`"
	if [ -z $sortCommands ] 
	then
	    sortCommands="$command"
	else
	    sortCommands="$sortCommands --- $command"
	fi
    done
    for pair in $commandWindowPairs
    do
    	sortLines="$sortLines\n$sortCommands:$pair:$desktop"
    done
}

getWindows()
{
    IFS=$'\n'
    local sortLines=""
    local lastDesktop
    local commandWindowPairs
    local window
    local desktop
    local pid
    local command
    for line in `wmctrl -lp`
    do 
	window=`echo $line | cut -d " " -f 1`
	desktop=`echo $line | cut -d " " -f 3`
        pid=`echo $line | cut -d " " -f 4`
        # title=`echo $line | cut -d " " -f 1,2,3,4,5,6 --complement` 
	command=`getCommand $pid`
	if [ "$desktop" != "$lastDesktop" ]
	then
	    if [ -n "$lastDesktop" ]
	    then
		appendSortLines "$commandWindowPairs" "$lastDesktop"
 	    fi
	    commandWindowPairs="$command:$window"
	    lastDesktop=$desktop
	else
	    commandWindowPairs="$commandWindowPairs\n$command:$window"
	fi
    done
    appendSortLines "$commandWindowPairs" "$lastDesktop"
    sortLines=`echo -e "$sortLines" | sort`
    local counter=1
    local visibleDesktop=`wmctrl -d | grep \* | cut -d " " -f 1`
    local gotoLines=""
    local commands
    local lastCommands
    for line in $sortLines 
    do 
	command=`echo $line | cut -d ":" -f 2`
	window=`echo $line | cut -d ":" -f 3`
	desktop=`echo $line | cut -d ":" -f 4`
	commands=`echo $line | cut -d ":" -f 1`
	if [ "$commands" != "$lastCommands" ]
	then
	    if [ -n "$gotoLines" ]
	    then
		gotoLines="$gotoLines\n"
	    fi
	    gotoLines="$gotoLines$counter goto $window "
 	    if [ "$desktop" = "$visibleDesktop" ] 
	    then
		gotoLines="$gotoLines*"
	    fi
	    gotoLines="$gotoLines$commands"
	fi
	lastCommands="$commands"
	let counter=$counter+1    
    done
    echo -e "$gotoLines"
#echo "-------------------------------------------------------------------------------------------------------------------------------------------------------------------------$bringLines"
#"$bringLines" on extra line causes trouble for some reason 
#echo "-------------------------------------------------------------------------------------------------------------------------------------------------------------------------"
}

main()
    {
	local desktop=`wmctrl -d | grep \* | cut -d " " -f 1`
	local line=`(getWindows;dmenu_path) | dmenu -i -l 13` 
	
	echo $line | grep "goto"
	
	if [ "$?" -eq "0" ]; then
	    local window=`echo $line | cut -d " " -f 3`
	    echo $window
	    wmctrl -ia $window
	else
	    echo $line | grep "bring"
	    
	    if [ "$?" -eq "0" ]; then
		local window=`echo $line | cut -d " " -f 3`
		wmctrl -iR $window
	    else
		exec $line
	    fi
	fi
    }

main
